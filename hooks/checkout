#!/bin/bash

set -euo pipefail # exit on failure or unset variable
set -v

if [ ! -d "${BUILDKITE_BUILD_CHECKOUT_PATH}/.git" ]; then
    echo "--- Init clone and checkout" 
    COUNT=1
    while true; do
        git clone ${BUILDKITE_GIT_CLONE_FLAGS} ${BUILDKITE_REPO} "${BUILDKITE_BUILD_CHECKOUT_PATH}"
        if [ $? -eq 0 ]; then
            break
        fi
        if [[ $COUNT -ge 3 ]]; then
            echo "Clone ${BUILDKITE_REPO} failed after 3 attempts"
            exit 1
        else
            echo "Clone ${BUILDKITE_REPO} failed, retrying..."
            sleep 30s
        fi 
        let COUNT=COUNT+1
    done
fi
set +v
