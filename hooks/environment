#!/bin/bash

# The `environment` hook will run before all other commands, and can be used
# to set up secrets, data, etc. Anything exported in hooks will be available
# to the build script.
#
# For example:
#
# export SECRET_VAR=token

set -euo pipefail # exit on failure or unset variable
set -v

export JULIA_DEPOT_PATH="$(dirname "$BUILDKITE_BUILD_CHECKOUT_PATH")/.julia"
export CI_OUTDIR="/central/scratchio/esm/buildkite/${BUILDKITE_BUILD_ID}"

# TODO: move to pipeline.yml somehow?
export CLIMATEMACHINE_SETTINGS_OUTPUT_DIR="${CI_OUTDIR}/${BUILDKITE_STEP_KEY}"

module purge
module load julia/1.4.2

case "${BUILDKITE_AGENT_META_DATA_CONFIG}" in
    # standard configurations

    "cpu")
        echo "--- cpu configuration"
        module load openmpi/4.0.3 hdf5/1.10.1 netcdf-c/4.6.1

        export JULIA_CUDA_USE_BINARYBUILDER=false
        export JULIA_MPI_BINARY=system

        export OMPI_MCA_btl="self,tcp"
        ;;

    "gpu")
        echo "--- gpu configuration"
        module load cuda/10.0 openmpi/4.0.3_cuda-10.0 hdf5/1.10.1 netcdf-c/4.6.1

        export JULIA_CUDA_USE_BINARYBUILDER=false
        export JULIA_MPI_BINARY=system

        export OMPI_MCA_btl="self,tcp"
        ;;

    *)
        echo "agent config must cpu or gpu"
        ;;

esac

set +v
